# ZenOps é’‰é’‰å¡ç‰‡æµå¼äº¤äº’ + LLM é›†æˆå®ç°æ€»ç»“

## å®Œæˆæ—¶é—´
2025-12-11

## åŠŸèƒ½æ¦‚è¿°

åŸºäº `tmp/chatgpt-dingtalk` é¡¹ç›®çš„å®ç°,ä¸º ZenOps é¡¹ç›®æ·»åŠ äº†ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½:

1. **é’‰é’‰æµå¼å¡ç‰‡äº¤äº’**: æ”¯æŒå®æ—¶æµå¼æ›´æ–°å¡ç‰‡å†…å®¹
2. **LLM å¤§æ¨¡å‹å¯¹è¯**: é›†æˆä¸»æµ LLM æä¾›å•†(OpenAIã€DeepSeek ç­‰)
3. **MCP å·¥å…·è‡ªåŠ¨è°ƒç”¨**: LLM å¯ä»¥è‡ªåŠ¨è°ƒç”¨é¡¹ç›®çš„ MCP å·¥å…·è·å–æ•°æ®
4. **å¤šæ¨¡å¼æ”¯æŒ**: ä¼ ç»Ÿæ„å›¾è§£æã€LLM å¯¹è¯ã€æµå¼å¡ç‰‡ç­‰å¤šç§äº¤äº’æ¨¡å¼

## å®ç°çš„æ–‡ä»¶

### 1. æ ¸å¿ƒæ¨¡å—

#### é’‰é’‰å¡ç‰‡æ¨¡å— (`internal/dingtalk/card.go`)
- `StreamCardClient`: æµå¼å¡ç‰‡å®¢æˆ·ç«¯
- `CreateAndDeliverCard`: åˆ›å»ºå¹¶æŠ•æ”¾æµå¼å¡ç‰‡
- `StreamingUpdate`: æµå¼æ›´æ–°å¡ç‰‡å†…å®¹
- `UpdateAIStreamCard`: ç®€åŒ–çš„æµå¼å¡ç‰‡æ›´æ–°æ–¹æ³•

**å…³é”®ç‰¹æ€§**:
- æ”¯æŒç¾¤èŠå’Œå•èŠä¸¤ç§åœºæ™¯
- æ”¯æŒ OpenSpaceID è‡ªåŠ¨æ„å»º
- æ”¯æŒé”™è¯¯çŠ¶æ€æ ‡è®°
- ä½¿ç”¨é’‰é’‰å®˜æ–¹ SDK

#### LLM å®¢æˆ·ç«¯æ¨¡å— (`internal/llm/client.go`)
- `Client`: LLM å®¢æˆ·ç«¯åŸºç±»
- `ChatWithMCPTools`: æ”¯æŒå·¥å…·è°ƒç”¨çš„å¯¹è¯æ–¹æ³•
- `getMCPTools`: è‡ªåŠ¨è·å–å¹¶è½¬æ¢ MCP å·¥å…·åˆ—è¡¨
- `executeToolCall`: æ‰§è¡Œ MCP å·¥å…·è°ƒç”¨

**å…³é”®ç‰¹æ€§**:
- å·¥å…·è°ƒç”¨å¾ªç¯(æœ€å¤š 10 æ¬¡è¿­ä»£)
- MCP Schema åˆ° OpenAI æ ¼å¼çš„è‡ªåŠ¨è½¬æ¢
- æ™ºèƒ½çš„ç³»ç»Ÿæç¤ºè¯ç”Ÿæˆ

#### OpenAI å…¼å®¹å®¢æˆ·ç«¯ (`internal/llm/openai.go`)
- `OpenAIClient`: OpenAI å…¼å®¹çš„ HTTP å®¢æˆ·ç«¯
- `Chat`: éæµå¼å¯¹è¯
- `ChatStream`: æµå¼å¯¹è¯
- `ChatWithToolsAndStream`: æ”¯æŒå·¥å…·è°ƒç”¨çš„æµå¼å¯¹è¯

**å…³é”®ç‰¹æ€§**:
- æ”¯æŒå¤šä¸ª LLM æä¾›å•†(OpenAIã€DeepSeekã€Azure)
- SSE æµå¼å“åº”è§£æ
- å·¥å…·è°ƒç”¨ä¸æµå¼å“åº”çš„å®Œç¾ç»“åˆ

### 2. æ¶ˆæ¯å¤„ç†å¢å¼º

#### æ›´æ–°çš„æ¶ˆæ¯å¤„ç†å™¨ (`internal/dingtalk/handler.go`)
æ–°å¢æ–¹æ³•:
- `processLLMWithStream`: ä½¿ç”¨æ™®é€šæµå¼æ¶ˆæ¯å¤„ç† LLM å¯¹è¯
- `processLLMWithStreamCard`: ä½¿ç”¨æµå¼å¡ç‰‡å¤„ç† LLM å¯¹è¯

**å¤„ç†æµç¨‹**:
1. æ£€æŸ¥æ˜¯å¦å¯ç”¨ LLM å¯¹è¯æ¨¡å¼
2. æ ¹æ®é…ç½®é€‰æ‹©æµå¼å¡ç‰‡æˆ–æ™®é€šæµå¼æ¶ˆæ¯
3. è°ƒç”¨ LLM å¹¶å®æ—¶æ›´æ–°å“åº”
4. è‡ªåŠ¨é™çº§:å¡ç‰‡åˆ›å»ºå¤±è´¥æ—¶ä½¿ç”¨æ™®é€šæ¶ˆæ¯

#### å›è°ƒæ¶ˆæ¯ç»“æ„å¢å¼º (`internal/dingtalk/callback.go`)
æ–°å¢å­—æ®µ:
- `ConversationType`: ä¼šè¯ç±»å‹(å•èŠ/ç¾¤èŠ)
- `SenderStaffID`: å‘é€è€…å‘˜å·¥ ID
- `RobotCode`: æœºå™¨äººä»£ç 

### 3. é…ç½®ç³»ç»Ÿ

#### é…ç½®ç»“æ„æ›´æ–° (`internal/config/config.go`)
æ–°å¢é…ç½®:
```go
type LLMConfig struct {
    Enabled  bool
    Provider string
    Model    string
    APIKey   string
    BaseURL  string
}

type DingTalkConfig struct {
    // ... åŸæœ‰å­—æ®µ
    CardTemplateID       string
    EnableStreamCard     bool
    EnableLLMConversation bool
}
```

#### é…ç½®ç¤ºä¾‹æ–‡ä»¶ (`config.example.yml`)
å®Œæ•´çš„é…ç½®ç¤ºä¾‹,åŒ…æ‹¬:
- LLM æä¾›å•†é…ç½®
- é’‰é’‰å¡ç‰‡æ¨¡æ¿é…ç½®
- å„ç§æ¨¡å¼å¼€å…³

### 4. æ–‡æ¡£

#### åŠŸèƒ½è¯´æ˜æ–‡æ¡£ (`docs/DINGTALK_LLM.md`)
åŒ…å«:
- åŠŸèƒ½æ¦‚è¿°å’Œç‰¹æ€§è¯´æ˜
- è¯¦ç»†çš„é…ç½®æŒ‡å—
- å¤šä¸ªä½¿ç”¨åœºæ™¯ç¤ºä¾‹
- å·¥ä½œåŸç†è¯´æ˜
- æ•…éšœæ’æŸ¥æŒ‡å—

#### å®ç°æ€»ç»“æ–‡æ¡£ (`docs/IMPLEMENTATION_SUMMARY.md`)
æœ¬æ–‡æ¡£,è®°å½•å®ç°ç»†èŠ‚ã€‚

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. æµå¼å¡ç‰‡æ›´æ–°æœºåˆ¶

```
ç”¨æˆ·æ¶ˆæ¯ -> åˆ›å»ºå¡ç‰‡ -> åˆå§‹å†…å®¹
                |
                v
          LLM æµå¼å“åº”
                |
                v
         ç¼“å†²æœºåˆ¶(300ms)
                |
                v
         æµå¼æ›´æ–°å¡ç‰‡å†…å®¹
                |
                v
         æ ‡è®°ä¸ºå®Œæˆ(IsFinalize)
```

**ç¼“å†²æœºåˆ¶**:
- æœ€å°æ›´æ–°é—´éš”: 300ms
- é¿å…é¢‘ç¹ API è°ƒç”¨
- æå‡ç”¨æˆ·ä½“éªŒ

### 2. MCP å·¥å…·è°ƒç”¨æµç¨‹

```
ç”¨æˆ·æé—® -> LLM åˆ†æ
              |
              v
      åˆ¤æ–­æ˜¯å¦éœ€è¦å·¥å…·?
         /           \
       Yes            No
        |              |
    å·¥å…·è°ƒç”¨åˆ—è¡¨    ç›´æ¥å›å¤
        |
        v
   å¹¶è¡Œæ‰§è¡Œå·¥å…·
        |
        v
   ç»“æœè¿”å› LLM
        |
        v
    LLM ç»¼åˆåˆ†æ
        |
        v
      æœ€ç»ˆå›å¤
```

**å…³é”®è®¾è®¡**:
- å·¥å…·å®šä¹‰è‡ªåŠ¨è½¬æ¢(MCP -> OpenAI æ ¼å¼)
- æ”¯æŒå¤šè½®å·¥å…·è°ƒç”¨(æœ€å¤š 10 è½®)
- å·¥å…·æ‰§è¡ŒçŠ¶æ€å®æ—¶é€šçŸ¥ç”¨æˆ·

### 3. å¤šæ¨¡å¼äº¤äº’æ¶æ„

```
ç”¨æˆ·æ¶ˆæ¯
    |
    v
æ˜¯å¦å¯ç”¨ LLM?
 /           \
No           Yes
 |            |
æ„å›¾è§£æ   æ˜¯å¦å¯ç”¨å¡ç‰‡?
 |         /           \
MCPè°ƒç”¨  Yes           No
 |       |              |
æ ¼å¼åŒ–  æµå¼å¡ç‰‡      æµå¼æ¶ˆæ¯
 |       |              |
 +-------+------+-------+
         |
      è¿”å›ç”¨æˆ·
```

### 4. é™çº§ç­–ç•¥

ç³»ç»Ÿå…·æœ‰å®Œå–„çš„é™çº§æœºåˆ¶:

1. **å¡ç‰‡åˆ›å»ºå¤±è´¥** -> é™çº§ä¸ºæ™®é€šæµå¼æ¶ˆæ¯
2. **LLM è°ƒç”¨å¤±è´¥** -> è¿”å›é”™è¯¯ä¿¡æ¯
3. **å·¥å…·è°ƒç”¨å¤±è´¥** -> è®°å½•é”™è¯¯,ç»§ç»­å¤„ç†
4. **æµå¼æ›´æ–°å¤±è´¥** -> è®°å½•è­¦å‘Š,ä¸ä¸­æ–­æµç¨‹

## é…ç½®è¯´æ˜

### æœ€å°é…ç½®(ä¸ä½¿ç”¨ LLM)

```yaml
dingtalk:
  enabled: true
  mode: "stream"
  app_key: "xxx"
  app_secret: "xxx"
  agent_id: "xxx"
  enable_llm_conversation: false

llm:
  enabled: false
```

### LLM å¯¹è¯é…ç½®(ä¸ä½¿ç”¨å¡ç‰‡)

```yaml
dingtalk:
  enabled: true
  mode: "stream"
  app_key: "xxx"
  app_secret: "xxx"
  agent_id: "xxx"
  enable_llm_conversation: true
  enable_stream_card: false

llm:
  enabled: true
  provider: "openai"
  model: "gpt-4"
  api_key: "sk-xxx"
```

### å®Œæ•´é…ç½®(LLM + æµå¼å¡ç‰‡)

```yaml
dingtalk:
  enabled: true
  mode: "stream"
  app_key: "xxx"
  app_secret: "xxx"
  agent_id: "xxx"
  enable_llm_conversation: true
  enable_stream_card: true
  card_template_id: "xxx.schema"

llm:
  enabled: true
  provider: "deepseek"
  model: "deepseek-chat"
  api_key: "sk-xxx"
  base_url: "https://api.deepseek.com"
```

## ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: ä¼ ç»Ÿæ¨¡å¼

```
ç”¨æˆ·: æŸ¥è¯¢é˜¿é‡Œäº‘ ECS åˆ—è¡¨
æœºå™¨äºº: [è¿”å› ECS åˆ—è¡¨]
```

### ç¤ºä¾‹ 2: LLM å¯¹è¯(æµå¼æ¶ˆæ¯)

```
ç”¨æˆ·: å¸®æˆ‘çœ‹çœ‹æœ‰å¤šå°‘å° ECS
æœºå™¨äºº:
  ğŸ¤– æ­£åœ¨æ€è€ƒ...

  ğŸ”§ è°ƒç”¨å·¥å…·: aliyun_ecs_list
  âœ… å·¥å…·æ‰§è¡Œå®Œæˆ

  æ ¹æ®æŸ¥è¯¢,å½“å‰æœ‰ 15 å° ECS å®ä¾‹...
```

### ç¤ºä¾‹ 3: LLM å¯¹è¯(æµå¼å¡ç‰‡)

```
[å¡ç‰‡å®æ—¶æ›´æ–°]
å¸®æˆ‘çœ‹çœ‹æœ‰å¤šå°‘å° ECS

æ­£åœ¨æ€è€ƒä¸­...
â†“
ğŸ”§ è°ƒç”¨å·¥å…·: aliyun_ecs_list
â†“
æ ¹æ®æŸ¥è¯¢,å½“å‰æœ‰ 15 å° ECS å®ä¾‹
[é€å­—æµå¼æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯]
```

## ä¾èµ–é¡¹

### æ–°å¢ä¾èµ–
æ— éœ€æ·»åŠ æ–°ä¾èµ–,å…¨éƒ¨ä½¿ç”¨é¡¹ç›®ç°æœ‰ä¾èµ–:
- `github.com/alibabacloud-go/dingtalk/card_1_0`: å¡ç‰‡ API
- `github.com/mark3labs/mcp-go`: MCP åè®®
- `github.com/google/uuid`: UUID ç”Ÿæˆ

### å…¼å®¹æ€§
- Go 1.23+
- é’‰é’‰å¼€æ”¾å¹³å° Stream SDK
- MCP åè®®

## æµ‹è¯•éªŒè¯

### ç¼–è¯‘æµ‹è¯•
```bash
$ go build -o bin/zenops .
# ç¼–è¯‘æˆåŠŸ,æ— é”™è¯¯
```

### åŠŸèƒ½æµ‹è¯•æ¸…å•

éœ€è¦æ‰‹åŠ¨æµ‹è¯•ä»¥ä¸‹åœºæ™¯:

- [ ] ä¼ ç»Ÿæ„å›¾è§£ææ¨¡å¼
- [ ] LLM æ™®é€šæµå¼æ¶ˆæ¯æ¨¡å¼
- [ ] LLM æµå¼å¡ç‰‡æ¨¡å¼
- [ ] MCP å·¥å…·è‡ªåŠ¨è°ƒç”¨
- [ ] å¤šè½®å·¥å…·è°ƒç”¨
- [ ] å¡ç‰‡åˆ›å»ºå¤±è´¥é™çº§
- [ ] LLM è°ƒç”¨å¤±è´¥å¤„ç†
- [ ] ç¾¤èŠå’Œå•èŠåœºæ™¯

## åç»­ä¼˜åŒ–å»ºè®®

1. **LLM æä¾›å•†æ‰©å±•**
   - æ·»åŠ æ›´å¤š LLM æä¾›å•†æ”¯æŒ(Claudeã€Gemini ç­‰)
   - å®ç°ç»Ÿä¸€çš„ LLM æ¥å£æŠ½è±¡

2. **å¯¹è¯ä¸Šä¸‹æ–‡ç®¡ç†**
   - å®ç°å¯¹è¯å†å²å­˜å‚¨
   - æ”¯æŒä¸Šä¸‹æ–‡è®°å¿†
   - æ”¯æŒå¤šè½®å¯¹è¯

3. **å·¥å…·è°ƒç”¨ä¼˜åŒ–**
   - å·¥å…·è°ƒç”¨ç¼“å­˜
   - å¹¶è¡Œå·¥å…·è°ƒç”¨
   - å·¥å…·è°ƒç”¨ç»“æœæ ¼å¼åŒ–

4. **ç›‘æ§å’Œç»Ÿè®¡**
   - LLM è°ƒç”¨æ¬¡æ•°ç»Ÿè®¡
   - Token ä½¿ç”¨é‡ç»Ÿè®¡
   - å“åº”æ—¶é—´ç›‘æ§
   - æˆæœ¬åˆ†æ

5. **å®‰å…¨å¢å¼º**
   - æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
   - æƒé™æ§åˆ¶å¢å¼º
   - å®¡è®¡æ—¥å¿—

6. **ç”¨æˆ·ä½“éªŒ**
   - æ›´ä¸°å¯Œçš„å¡ç‰‡æ ·å¼
   - æ”¯æŒå›¾ç‰‡ã€é™„ä»¶ç­‰
   - æ”¯æŒäº¤äº’å¼æŒ‰é’®

## å‚è€ƒèµ„æ–™

- å‚è€ƒé¡¹ç›®: `tmp/chatgpt-dingtalk`
- é’‰é’‰å¼€æ”¾å¹³å°: https://open.dingtalk.com/
- MCP åè®®: https://github.com/mark3labs/mcp-go
- OpenAI API: https://platform.openai.com/docs

## æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸä¸º ZenOps é¡¹ç›®æ·»åŠ äº†é’‰é’‰æµå¼å¡ç‰‡äº¤äº’å’Œ LLM æ™ºèƒ½å¯¹è¯èƒ½åŠ›,ä½¿å¾—:

1. âœ… ç”¨æˆ·å¯ä»¥é€šè¿‡é’‰é’‰ä¸ LLM è¿›è¡Œè‡ªç„¶è¯­è¨€å¯¹è¯
2. âœ… LLM å¯ä»¥è‡ªåŠ¨è°ƒç”¨é¡¹ç›®çš„ MCP å·¥å…·è·å–å®æ—¶æ•°æ®
3. âœ… æ”¯æŒæµå¼å¡ç‰‡å®æ—¶æ›´æ–°,æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ
4. âœ… å®Œå–„çš„é™çº§æœºåˆ¶,ä¿è¯ç³»ç»Ÿç¨³å®šæ€§
5. âœ… çµæ´»çš„é…ç½®ç³»ç»Ÿ,æ”¯æŒå¤šç§ä½¿ç”¨åœºæ™¯

ä»£ç å·²é€šè¿‡ç¼–è¯‘æµ‹è¯•,å¯ä»¥è¿›è¡ŒåŠŸèƒ½æµ‹è¯•å’Œéƒ¨ç½²ã€‚
